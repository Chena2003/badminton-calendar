name: Detect DB Changes
on:
  push:
    branches: [main]
    paths:
      - '_db/**/2025.json'
      - '_db/**/2026.json'
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Determine changed site
        id: determine-site
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '_db/.*\.json' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "Using alternative method to find changed files"
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '_db/.*\.json' || echo "")
          fi

          echo "Changed files: $CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q '_db/badminton/'; then
            echo "site=badminton" >> $GITHUB_OUTPUT
          else
            echo "No matching site found in changed files"
            exit 1
          fi

      - name: Trigger ICS Deployment Workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log("Triggering ICS deployment workflow for site: ${{ steps.determine-site.outputs.site }}");
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ics.yml',
              ref: 'main',
              inputs: {
                site: '${{ steps.determine-site.outputs.site }}'
              }
            })

      - name: Wait for Queue Generation to Complete
        run: |
          sleep 15

      - name: Trigger Queue Generation Workflow
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log("Triggering workflow for site: ${{ steps.determine-site.outputs.site }}");
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'queues.yml',
              ref: 'main',
              inputs: {
                site: '${{ steps.determine-site.outputs.site }}'
              }
            })
